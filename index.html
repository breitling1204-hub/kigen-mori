<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期限の森 | AI食材管理＆レシピ提案</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 2.5rem; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .premium-btn { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .ai-btn { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3); }
        .gold-tree { color: #f59e0b; filter: drop-shadow(0 0 5px rgba(245, 158, 11, 0.4)); }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [forest, setForest] = useState([]);
            const [isPremium, setIsPremium] = useState(false);
            const [showLegal, setShowLegal] = useState(false);
            const [name, setName] = useState('');
            const [date, setDate] = useState('');
            const [quantity, setQuantity] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [aiRecipe, setAiRecipe] = useState(null);

            // Google Gemini API Key (システムより自動注入)
            const apiKey = "";

            useEffect(() => {
                const savedForest = localStorage.getItem('kigen_forest_final');
                if (savedForest) setForest(JSON.parse(savedForest));
                const premiumStatus = localStorage.getItem('kigen_premium_status') === 'true';
                setIsPremium(premiumStatus);
            }, []);

            const addTree = () => {
                if (!name || !date) return;
                const newTree = {
                    id: Date.now(),
                    name: name,
                    date: date,
                    quantity: quantity || '1個',
                    selected: false,
                    isGold: isPremium
                };
                const updatedForest = [newTree, ...forest];
                setForest(updatedForest);
                localStorage.setItem('kigen_forest_final', JSON.stringify(updatedForest));
                setName(''); setDate(''); setQuantity('');
            };

            const toggleSelect = (id) => {
                if (!isPremium) return;
                setForest(forest.map(t => t.id === id ? { ...t, selected: !t.selected } : t));
            };

            const removeTree = (id, e) => {
                e.stopPropagation();
                const updatedForest = forest.filter(t => t.id !== id);
                setForest(updatedForest);
                localStorage.setItem('kigen_forest_final', JSON.stringify(updatedForest));
            };

            const togglePremium = () => {
                const next = !isPremium;
                setIsPremium(next);
                localStorage.setItem('kigen_premium_status', next.toString());
            };

            const askAI = async () => {
                const selected = forest.filter(t => t.selected);
                if (selected.length === 0) return;

                setAiLoading(true);
                const ingredients = selected.map(t => `${t.name}(${t.quantity})`).join(', ');
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `${ingredients}を使った、簡単で美味しい料理のレシピを3つ提案してください。作り方のポイントも短く教えて。` }] }],
                            systemInstruction: { parts: [{ text: "あなたはプロの料理研究家です。ユーザーが持つ食材を無駄にしない、最高の献立を提案してください。返信は日本語で、親しみやすいトーンでお願いします。" }] }
                        })
                    });
                    const result = await response.json();
                    setAiRecipe(result.candidates?.[0]?.content?.parts?.[0]?.text || "レシピが見つかりませんでした。");
                } catch (error) {
                    setAiRecipe("森の精霊との通信に失敗しました。後ほどお試しください。");
                } finally {
                    setAiLoading(false);
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen p-6 pb-32">
                    {/* Header */}
                    <header className="flex justify-between items-center py-6 mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`p-3 rounded-2xl text-white shadow-lg ${isPremium ? 'bg-amber-500' : 'bg-emerald-600'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 10c.1-4.4-4.9-7-9-7s-9.1 2.6-9 7c0 1.9.7 3.7 2 5 1.3 1.3 3 2.1 4.9 2.1H7c-1.1 0-2 .9-2 2s.9 2 2 2h2c1.1 0 2-.9 2-2s-.9-2-2-2h-.1c1.9 0 3.6-.8 4.9-2.1 1.3-1.3 2-3.1 2-5z"/></svg>
                            </div>
                            <div>
                                <h1 className="font-black text-2xl tracking-tighter">期限の森</h1>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">AI Inventory Assist</p>
                            </div>
                        </div>
                        <button onClick={togglePremium} className={`text-[10px] font-black px-4 py-2 rounded-full shadow-md transition-all active:scale-95 ${isPremium ? 'bg-white text-amber-500 border border-amber-200' : 'bg-slate-900 text-white'}`}>
                            {isPremium ? '★ PREMIUM' : 'UPGRADE'}
                        </button>
                    </header>

                    {/* Input Area */}
                    <div className="glass-card p-8 mb-10">
                        <div className="space-y-4">
                            <input 
                                value={name} onChange={e => setName(e.target.value)}
                                placeholder="食材の名前" 
                                className="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm border border-transparent focus:border-emerald-200 transition-all"
                            />
                            <div className="flex gap-3">
                                <input 
                                    value={quantity} onChange={e => setQuantity(e.target.value)}
                                    placeholder="数量 (2個, 200g等)" 
                                    className="w-1/2 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm border border-transparent"
                                />
                                <input 
                                    value={date} onChange={e => setDate(e.target.value)}
                                    type="date" 
                                    className="w-1/2 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-sm border border-transparent"
                                />
                            </div>
                            <button onClick={addTree} className={`w-full py-5 rounded-2xl font-black text-xs uppercase tracking-widest text-white shadow-xl active:scale-95 transition-all ${isPremium ? 'bg-amber-500 shadow-amber-200' : 'bg-emerald-600 shadow-emerald-200'}`}>
                                森に食材を植える
                            </button>
                        </div>
                    </div>

                    {/* List Area */}
                    <div className="space-y-3">
                        <div className="flex justify-between px-2 mb-2 items-center">
                            <h2 className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Current Inventory</h2>
                            {isPremium && <span className="text-[9px] font-bold text-amber-500 animate-pulse-soft">食材を選んでAI提案！</span>}
                        </div>
                        {forest.length === 0 && (
                            <div className="text-center py-20 opacity-20 font-bold text-sm">森はまだ空っぽです</div>
                        )}
                        {forest.map(tree => {
                            const diff = Math.ceil((new Date(tree.date) - new Date()) / 86400000);
                            return (
                                <div 
                                    key={tree.id} 
                                    onClick={() => toggleSelect(tree.id)}
                                    className={`bg-white p-5 rounded-[2.2rem] flex items-center gap-5 border-2 transition-all ${tree.selected ? 'border-amber-400 bg-amber-50/50 scale-[1.02]' : 'border-white'}`}
                                >
                                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${tree.isGold ? 'bg-amber-50 text-amber-500' : 'bg-slate-50 text-emerald-600'}`}>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.05 6.11 6.07 6.07 0 0 0 11 11c.73 0 1.39-.27 1.88-.71a3.5 3.5 0 0 1 6.07 3.6 7 7 0 0 1-7.95 6.11Z"/></svg>
                                    </div>
                                    <div className="flex-1">
                                        <p className="font-black text-[15px] text-slate-800 leading-tight">{tree.name}</p>
                                        <p className="text-[10px] font-bold text-slate-400 mt-1">{tree.quantity} • あと <span className={diff <= 3 ? 'text-rose-500' : 'text-emerald-500'}>{diff}日</span></p>
                                    </div>
                                    <button onClick={(e) => removeTree(tree.id, e)} className="p-2 text-slate-200 hover:text-rose-400"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2m-9 5v6m4-6v6"/></svg></button>
                                </div>
                            );
                        })}
                    </div>

                    {/* AI Button */}
                    {isPremium && forest.some(t => t.selected) && (
                        <div className="fixed bottom-10 left-0 right-0 px-6 flex justify-center z-40">
                            <button 
                                onClick={askAI} 
                                disabled={aiLoading}
                                className="ai-btn text-white px-10 py-5 rounded-full font-black text-xs shadow-2xl flex items-center gap-3 animate-bounce active:scale-95 transition-all"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="text-amber-400" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                                {aiLoading ? "AIがレシピを考案中..." : "この食材でレシピを提案！"}
                            </button>
                        </div>
                    )}

                    {/* AI Result Modal */}
                    {aiRecipe && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-50 p-8 flex items-center justify-center">
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 max-h-[80vh] overflow-y-auto relative">
                                <button onClick={() => setAiRecipe(null)} className="absolute top-8 right-8 text-slate-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                                </button>
                                <h2 className="font-black text-xl mb-6 flex items-center gap-2">
                                    <span className="text-amber-500">✨</span> AIシェフの提案
                                </h2>
                                <div className="text-[13px] leading-relaxed text-slate-600 whitespace-pre-wrap font-medium">
                                    {aiRecipe}
                                </div>
                                <button onClick={() => setAiRecipe(null)} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-black mt-10 text-xs active:scale-95 shadow-xl">森に戻る</button>
                            </div>
                        </div>
                    )}

                    {/* Legal Footer */}
                    <footer className="mt-24 text-center pb-10">
                        <button onClick={() => setShowLegal(true)} className="text-[10px] font-bold text-slate-300 underline underline-offset-4 tracking-widest uppercase">特定商取引法に基づく表記</button>
                        <p className="text-[8px] text-slate-300 mt-4 font-black">© 2024 KIGEN NO MORI AI</p>
                    </footer>

                    {/* Legal Modal */}
                    {showLegal && (
                        <div className="fixed inset-0 bg-white z-[60] p-10 overflow-y-auto">
                            <div className="max-w-xs mx-auto">
                                <button onClick={() => setShowLegal(false)} className="text-slate-300 mb-10 font-black flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg> BACK
                                </button>
                                <h3 className="font-black text-2xl mb-10 leading-tight">特定商取引法に<br/>基づく表記</h3>
                                <div className="space-y-8 text-[11px] text-slate-500 font-medium">
                                    <section>
                                        <p className="font-black text-slate-900 uppercase text-[9px] mb-2 tracking-widest">販売業者</p>
                                        <p>（あなたの本名をご記入ください）</p>
                                    </section>
                                    <section>
                                        <p className="font-black text-slate-900 uppercase text-[9px] mb-2 tracking-widest">お問い合わせ先</p>
                                        <p>（あなたのメールアドレスをご記入ください）</p>
                                    </section>
                                    <section>
                                        <p className="font-black text-slate-900 uppercase text-[9px] mb-2 tracking-widest">販売価格</p>
                                        <p>プレミアムプラン：300円（税込）</p>
                                    </section>
                                    <section>
                                        <p className="font-black text-slate-900 uppercase text-[9px] mb-2 tracking-widest">商品引渡し時期</p>
                                        <p>決済完了後、即時提供されます。</p>
                                    </section>
                                    <section>
                                        <p className="font-black text-slate-900 uppercase text-[9px] mb-2 tracking-widest">返品・キャンセル</p>
                                        <p>デジタルコンテンツの性質上、決済後の返金・返品はできません。</p>
                                    </section>
                                </div>
                                <button onClick={() => setShowLegal(false)} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-black mt-16 text-xs shadow-2xl">同意して閉じる</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

